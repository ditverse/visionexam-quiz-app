@model List<QuizApp.Models.QuizAttempt>
@{
    ViewData["Title"] = "Riwayat Quiz - VisionExam";
}

<div class="history-container">
    <!-- Header -->
    <div class="history-header">
        <div class="header-content">
            <h1 class="page-title">Riwayat Quiz</h1>
            <p class="page-subtitle">Lihat semua quiz yang pernah Anda kerjakan</p>
        </div>
        <div class="header-actions">
            <a href="/Quiz" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Quiz Baru
            </a>
        </div>
    </div>

    @if (Model.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-history"></i>
            </div>
            <h3>Belum Ada Riwayat</h3>
            <p>Anda belum mengerjakan quiz apapun. Mulai quiz pertama Anda sekarang!</p>
            <a href="/Quiz" class="btn btn-primary">
                <i class="fas fa-play"></i>
                Mulai Quiz
            </a>
        </div>
    }
    else
    {
        <!-- Filter & Stats -->
        <div class="history-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.Count</div>
                    <div class="stat-label">Total Quiz</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.Count(a => a.IsCompleted)</div>
                    <div class="stat-label">Selesai</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    @{
                        var avgScore = Model.Where(a => a.IsCompleted && a.MaxScore > 0).DefaultIfEmpty(new QuizApp.Models.QuizAttempt { Score = 0, MaxScore = 1 }).Average(a => a.MaxScore > 0 ? (double)a.Score / a.MaxScore * 100 : 0);
                    }
                    <div class="stat-number">@avgScore.ToString("F0")%</div>
                    <div class="stat-label">Rata-rata Skor</div>
                </div>
            </div>
        </div>

        <!-- Quiz History Grid -->
        <div class="history-grid">
            @foreach (var attempt in Model)
            {
                var percentage = attempt.MaxScore > 0 ? (double)attempt.Score / attempt.MaxScore * 100 : 0;
                var grade = percentage >= 80 ? "A" : percentage >= 70 ? "B" : percentage >= 60 ? "C" : percentage >= 50 ? "D" : "E";
                var gradeColor = percentage >= 80 ? "success" : percentage >= 70 ? "primary" : percentage >= 60 ? "warning" : percentage >= 50 ? "orange" : "danger";
                
                <div class="history-card">
                    <div class="history-header">
                        <h3 class="quiz-title">@(attempt.Quiz?.Title ?? "Quiz Tidak Diketahui")</h3>
                        <span class="quiz-status @(attempt.IsCompleted ? "status-completed" : "status-incomplete")">
                            @(attempt.IsCompleted ? "Selesai" : "Belum Selesai")
                        </span>
                    </div>
                    
                    <div class="history-content">
                        <div class="quiz-info">
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>@attempt.StartedAt.ToString("dd MMM yyyy, HH:mm")</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>@((attempt.CompletedAt - attempt.StartedAt)?.TotalMinutes.ToString("F1")) menit</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-question-circle"></i>
                                <span>@attempt.Quiz?.Questions.Count soal</span>
                            </div>
                        </div>
                        
                        <div class="score-section">
                            <div class="score-display">
                                <div class="score-grade grade-@gradeColor">@grade</div>
                                <div class="score-details">
                                    <div class="score-number">@attempt.Score/@attempt.MaxScore</div>
                                    <div class="score-percentage">(@percentage.ToString("F0")%)</div>
                                </div>
                            </div>
                        </div>
                        
                        @if (attempt.Violations.Count > 0)
                        {
                            <div class="violations-section">
                                <div class="violations-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>@attempt.Violations.Count Pelanggaran</span>
                                </div>
                                <div class="violations-list">
                                    @{
                                        var lookLeft = attempt.Violations.Count(v => v.Type == QuizApp.Models.ViolationType.LookLeft);
                                        var lookRight = attempt.Violations.Count(v => v.Type == QuizApp.Models.ViolationType.LookRight);
                                        var noFace = attempt.Violations.Count(v => v.Type == QuizApp.Models.ViolationType.NoFace);
                                        var multiFace = attempt.Violations.Count(v => v.Type == QuizApp.Models.ViolationType.MultipleFaces);
                                    }
                                    @if (lookLeft > 0) { <div class="violation-item">Menoleh Kiri: @lookLeft</div> }
                                    @if (lookRight > 0) { <div class="violation-item">Menoleh Kanan: @lookRight</div> }
                                    @if (noFace > 0) { <div class="violation-item">Wajah Tidak Terdeteksi: @noFace</div> }
                                    @if (multiFace > 0) { <div class="violation-item">Banyak Wajah: @multiFace</div> }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="clean-badge">
                                <i class="fas fa-shield-check"></i>
                                <span>Bersih</span>
                            </div>
                        }
                    </div>
                    
                    <div class="history-footer">
                        <a href="/Quiz/Result/@attempt.Id" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i>
                            Lihat Detail
                        </a>
                    </div>
                </div>
            }
        </div>
    }
</div>

<link rel="stylesheet" href="~/css/history.css" />
<script src="~/js/history.js"></script>