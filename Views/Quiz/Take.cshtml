@model QuizApp.Models.Quiz
@{
    ViewData["Title"] = $"Quiz: {Model.Title}";
    var attemptId = ViewData["AttemptId"];
    var startedAt = ViewData["StartedAt"];
}

<div class="grid lg:grid-cols-3 gap-6">
    <!-- Main Quiz Area -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-900">@Model.Title</h1>
                <div id="timer" class="text-xl font-mono bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg">
                    00:00
                </div>
            </div>

            <!-- Warning Banner -->
            <div id="warning-banner" class="hidden mb-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded warning-pulse">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span id="warning-message">Peringatan!</span>
                </div>
            </div>

            <!-- Questions -->
            <div id="questions-container">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    var question = Model.Questions.ElementAt(i);
                    var options = System.Text.Json.JsonSerializer.Deserialize<List<string>>(question.OptionsJson) ?? new List<string>();
                    
                    <div class="question-card mb-6 p-6 border rounded-xl @(i == 0 ? "" : "hidden")" data-question-id="@question.Id" data-index="@i">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-indigo-600">Soal @(i + 1) dari @Model.Questions.Count</span>
                            <span class="text-sm text-gray-500">@question.Points poin</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">@question.Text</h3>
                        
                        <div class="space-y-3">
                            @for (int j = 0; j < options.Count; j++)
                            {
                                <label class="option-label flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition">
                                    <input type="radio" name="question_@question.Id" value="@j" class="w-5 h-5 text-indigo-600">
                                    <span class="ml-3 text-gray-700">@options[j]</span>
                                </label>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Navigation -->
            <div class="flex justify-between mt-6">
                <button id="prev-btn" onclick="prevQuestion()" disabled
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition hover:bg-gray-300">
                    Sebelumnya
                </button>
                <button id="next-btn" onclick="nextQuestion()"
                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium transition hover:bg-indigo-700">
                    Selanjutnya
                </button>
                <form id="complete-form" method="post" asp-controller="Quiz" asp-action="Complete" class="hidden">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="attemptId" value="@attemptId" />
                    <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium transition hover:bg-green-700">
                        Selesai & Submit
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Webcam & Stats -->
    <div class="space-y-6">
        <!-- Webcam -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Webcam Monitor
            </h3>
            <div class="relative bg-gray-900 rounded-lg overflow-hidden aspect-video">
                <video id="webcam" autoplay muted playsinline class="w-full h-full object-cover"></video>
                <canvas id="overlay" class="absolute top-0 left-0 w-full h-full"></canvas>
                <div id="webcam-status" class="absolute bottom-2 left-2 text-xs text-white bg-black/50 px-2 py-1 rounded">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Violation Stats -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Statistik Pelanggaran</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Menoleh Kiri:</span>
                    <span id="stat-left" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Menoleh Kanan:</span>
                    <span id="stat-right" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Wajah Tidak Terdeteksi:</span>
                    <span id="stat-noface" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Banyak Wajah:</span>
                    <span id="stat-multi" class="font-medium">0</span>
                </div>
            </div>
        </div>

        <!-- Question Navigator -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Navigasi Soal</h3>
            <div class="grid grid-cols-5 gap-2">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    <button onclick="goToQuestion(@i)" 
                            class="question-nav w-10 h-10 rounded-lg text-sm font-medium border-2 border-gray-200 hover:border-indigo-500 transition @(i == 0 ? "bg-indigo-600 text-white border-indigo-600" : "")"
                            data-index="@i">
                        @(i + 1)
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/quiz-take.css" />

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script>
        const attemptId = parseInt('@ViewData["AttemptId"]');
        const durationMinutes = @Model.DurationMinutes;
        const totalQuestions = @Model.Questions.Count;
        let currentQuestion = 0;
        let answers = {};
        let violationStats = { left: 0, right: 0, noface: 0, multi: 0 };
        
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // ===== SIMPLE TIMER - IGNORE SERVER TIME =====
        let timeRemaining = durationMinutes * 60; // Mulai dari durasi penuh
        let timerInterval = null;
        
        function updateTimer() {
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').textContent = '00:00';
                alert('Waktu habis! Quiz akan di-submit otomatis.');
                submitQuiz();
                return;
            }
            
            timeRemaining--;
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 300) {
                document.getElementById('timer').classList.add('bg-red-100', 'text-red-800');
                document.getElementById('timer').classList.remove('bg-indigo-100', 'text-indigo-800');
            }
        }

        function submitQuiz() {
            saveCurrentAnswer();
            document.getElementById('complete-form').submit();
        }

        // Question Navigation
        function showQuestion(index) {
            document.querySelectorAll('.question-card').forEach((card, i) => {
                card.classList.toggle('hidden', i !== index);
            });
            document.querySelectorAll('.question-nav').forEach((btn, i) => {
                btn.classList.toggle('bg-indigo-600', i === index);
                btn.classList.toggle('text-white', i === index);
                btn.classList.toggle('border-indigo-600', i === index);
            });
            
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').classList.toggle('hidden', index === totalQuestions - 1);
            document.getElementById('complete-form').classList.toggle('hidden', index !== totalQuestions - 1);
            
            currentQuestion = index;
        }

        function nextQuestion() {
            saveCurrentAnswer();
            if (currentQuestion < totalQuestions - 1) {
                showQuestion(currentQuestion + 1);
            }
        }

        function prevQuestion() {
            saveCurrentAnswer();
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }

        function goToQuestion(index) {
            saveCurrentAnswer();
            showQuestion(index);
        }

        function saveCurrentAnswer() {
            const card = document.querySelector(`.question-card[data-index="${currentQuestion}"]`);
            const questionId = card.dataset.questionId;
            const selected = card.querySelector('input[type="radio"]:checked');
            
            if (selected) {
                const selectedOption = parseInt(selected.value);
                answers[questionId] = selectedOption;
                
                document.querySelector(`.question-nav[data-index="${currentQuestion}"]`).classList.add('bg-green-100', 'border-green-500');
                
                fetch('/Quiz/SubmitAnswer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': antiForgeryToken
                    },
                    body: `attemptId=${attemptId}&questionId=${questionId}&selectedOption=${selectedOption}`
                }).catch(err => console.error('Submit error:', err));
            }
        }

        // ===== FACE DETECTION =====
        let modelsLoaded = false;
        
        async function initFaceDetection() {
            const video = document.getElementById('webcam');
            const status = document.getElementById('webcam-status');
            
            try {
                status.textContent = 'Loading models...';
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL)
                ]);
                
                modelsLoaded = true;
                status.textContent = 'Requesting camera...';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' },
                    audio: false
                });
                
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                status.textContent = 'Detecting...';
                setTimeout(detectFace, 1000);
                
            } catch (err) {
                console.error('Camera error:', err);
                status.textContent = `Error: ${err.message}`;
                status.className = 'absolute bottom-2 left-2 text-xs text-white bg-red-500 px-2 py-1 rounded';
            }
        }

        let detectionRunning = false;
        
        async function detectFace() {
            if (detectionRunning) return;
            detectionRunning = true;
            
            const video = document.getElementById('webcam');
            const status = document.getElementById('webcam-status');
            
            try {
                if (!modelsLoaded || video.readyState !== 4) {
                    detectionRunning = false;
                    setTimeout(detectFace, 500);
                    return;
                }
                
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                    .withFaceLandmarks(true);
                
                if (detections.length === 0) {
                    logViolation(2, 'NoFace');
                    status.textContent = 'Wajah tidak terdeteksi';
                    status.className = 'absolute bottom-2 left-2 text-xs text-white bg-red-500/80 px-2 py-1 rounded';
                } 
                else if (detections.length > 1) {
                    logViolation(3, 'MultipleFaces');
                    status.textContent = `${detections.length} wajah`;
                    status.className = 'absolute bottom-2 left-2 text-xs text-white bg-red-500/80 px-2 py-1 rounded';
                } 
                else {
                    const landmarks = detections[0].landmarks.positions;
                    const nose = landmarks[30];
                    const leftEye = landmarks[36];
                    const rightEye = landmarks[45];
                    
                    const faceWidth = Math.abs(rightEye.x - leftEye.x);
                    const faceCenterX = (leftEye.x + rightEye.x) / 2;
                    const noseDeviation = nose.x - faceCenterX;
                    const deviationRatio = noseDeviation / faceWidth;
                    
                    const THRESHOLD = 0.15;
                    
                    if (deviationRatio < -THRESHOLD) {
                        logViolation(0, 'LookLeft');
                        status.textContent = 'Melihat kiri';
                        status.className = 'absolute bottom-2 left-2 text-xs text-white bg-yellow-500/80 px-2 py-1 rounded';
                    } 
                    else if (deviationRatio > THRESHOLD) {
                        logViolation(1, 'LookRight');
                        status.textContent = 'Melihat kanan';
                        status.className = 'absolute bottom-2 left-2 text-xs text-white bg-yellow-500/80 px-2 py-1 rounded';
                    } 
                    else {
                        lastViolationType = null;
                        status.textContent = 'OK ✓';
                        status.className = 'absolute bottom-2 left-2 text-xs text-white bg-green-500/80 px-2 py-1 rounded';
                    }
                }
                
            } catch (err) {
                console.error('Detection error:', err);
            }
            
            detectionRunning = false;
            setTimeout(detectFace, 300);
        }

        let lastViolationType = null;
        let lastViolationTime = 0;

        function logViolation(type, typeName) {
            const now = Date.now();
            if (lastViolationType === type && now - lastViolationTime < 2000) return;
            
            lastViolationType = type;
            lastViolationTime = now;
            
            if (type === 0) violationStats.left++;
            else if (type === 1) violationStats.right++;
            else if (type === 2) violationStats.noface++;
            else if (type === 3) violationStats.multi++;
            
            document.getElementById('stat-left').textContent = violationStats.left;
            document.getElementById('stat-right').textContent = violationStats.right;
            document.getElementById('stat-noface').textContent = violationStats.noface;
            document.getElementById('stat-multi').textContent = violationStats.multi;
            
            const banner = document.getElementById('warning-banner');
            const message = document.getElementById('warning-message');
            const messages = {
                0: '⚠️ Melihat ke kiri!',
                1: '⚠️ Melihat ke kanan!',
                2: '⚠️ Wajah tidak terdeteksi!',
                3: '⚠️ Lebih dari satu wajah!'
            };
            
            message.textContent = messages[type];
            banner.classList.remove('hidden');
            setTimeout(() => banner.classList.add('hidden'), 3000);
            
            fetch('/Violation/Log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': antiForgeryToken
                },
                body: `attemptId=${attemptId}&violationType=${type}`
            }).catch(err => console.error('Log error:', err));
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Quiz started - Duration:', durationMinutes, 'minutes');
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            
            initFaceDetection();
            
            window.addEventListener('beforeunload', (e) => {
                if (currentQuestion < totalQuestions - 1) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
}